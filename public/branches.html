<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Филиалы — Bloknot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div id="app-header"></div>

  <main class="container">
    <h1 class="page-title">Филиалы</h1>
    <p class="page-subtitle">Добавляйте адреса, которые клиенты будут выбирать в онлайн‑записи.</p>

    <div class="card stack">
      <div id="notice" class="notice" style="display:none"></div>
      <div id="list" class="list"></div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2 style="margin:0 0 10px">Добавить филиал</h2>

      <div class="row two">
        <div class="field">
          <label for="name">Название</label>
          <input id="name" placeholder="Например: Центр" />
        </div>
        <div class="field">
          <label for="address">Адрес (опционально)</label>
          <input id="address" placeholder="Город, улица, дом" />
        </div>
      </div>

      <div class="actions" style="margin-top:10px">
        <button class="btn" id="addBtn">Добавить</button>
        <button class="btn secondary" id="clearBtn" type="button">Очистить</button>
      </div>
    </div>
  </main>

  <script src="/app.js"></script>
  <script>
    const notice = Bloknot.qs("#notice");
    function showNotice(text) {
      if (!text) {
        notice.style.display = "none";
        notice.textContent = "";
        return;
      }
      notice.style.display = "block";
      notice.textContent = text;
    }

    async function loadBranches() {
      const items = await Bloknot.api("/api/branches");
      const host = Bloknot.qs("#list");
      host.innerHTML = "";

      if (!items.length) {
        host.innerHTML = '<div class="notice">Пока нет филиалов. Добавьте первый ниже.</div>';
        return;
      }

      items.forEach((b) => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div class="item-title">${Bloknot.esc(b.name)}</div>
            <div class="item-meta">${b.address ? Bloknot.esc(b.address) : ""}</div>
          </div>
          <div class="actions">
            <button class="btn secondary" data-action="delete" data-id="${b.id}">Удалить</button>
          </div>
        `;
        host.appendChild(div);
      });
    }

    function clearForm() {
      Bloknot.qs("#name").value = "";
      Bloknot.qs("#address").value = "";
    }

    async function addBranch() {
      const name = Bloknot.qs("#name").value.trim();
      const address = Bloknot.qs("#address").value.trim();
      if (!name) {
        showNotice("Введите название филиала.");
        return;
      }
      showNotice("");
      Bloknot.qs("#addBtn").disabled = true;
      try {
        await Bloknot.api("/api/branches", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, address: address || null }),
        });
        clearForm();
        await loadBranches();
      } catch (e) {
        showNotice("Не удалось добавить филиал: " + e.message);
      } finally {
        Bloknot.qs("#addBtn").disabled = false;
      }
    }

    async function deleteBranch(id) {
      if (!confirm("Удалить филиал?")) return;
      showNotice("");
      try {
        await Bloknot.api("/api/branches/" + id, { method: "DELETE" });
        await loadBranches();
      } catch (e) {
        showNotice("Не удалось удалить филиал: " + e.message);
      }
    }

    Bloknot.renderHeader("branches");
    Bloknot.qs("#addBtn").addEventListener("click", addBranch);
    Bloknot.qs("#clearBtn").addEventListener("click", clearForm);
    Bloknot.qs("#list").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      if (btn.dataset.action === "delete") deleteBranch(btn.dataset.id);
    });

    (async function init() {
      try {
        await loadBranches();
      } catch (e) {
        showNotice("Сервер недоступен: " + e.message);
      }
    })();
  </script>
</body>
</html>
